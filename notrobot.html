<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Etsi autot</title>

  <!-- Ulkoinen tyylitiedosto -->
  <link rel="stylesheet" href="style/notrobot.css">

  <!-- Nopeampi yhteys Google Fonts -palveluun -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <h2>Valitse kaikki kuvat joissa esiintyy auto</h2>

  <!-- Kuvaruudukko -->
  <div class="grid" id="captchaGrid"></div>

  <!-- Tarkistusnappi -->
  <button onclick="verifySelection()">Tarkista</button>

  <!-- Alusta-nappi (uudelleenj√§rjest√§√§ kuvat) -->
  <!--<button onclick="reloadCaptcha()">Alusta</button>-->

  <!-- Tulosviesti -->
  <p id="result"></p>

  <!-- JavaScript alkaa -->
  

  <script>
  const images = [
    { src: 'images/notrobot/car1.jpg', isCar: true },
    { src: 'images/notrobot/isitornot.jpg', isCar: false },
    { src: 'images/notrobot/car2.jpg', isCar: true },
    { src: 'images/notrobot/isitornot1.jpg', isCar: false },
    { src: 'images/notrobot/car3.jpg', isCar: true },
    { src: 'images/notrobot/maybecar1.jpg', isCar: true },
    { src: 'images/notrobot/maybecar2.jpg', isCar: false },
    { src: 'images/notrobot/maybecar3.jpg', isCar: false },
    { src: 'images/notrobot/maybecar4.jpg', isCar: false }
  ];

  const grid = document.getElementById('captchaGrid');
  let attemptCount = 0;
  let testCompleted = false; // Est√§√§ lis√§yritykset onnistumisen j√§lkeen

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function renderGrid() {
    grid.innerHTML = '';
    shuffle(images);

    images.forEach((img, index) => {
      const imageElement = document.createElement('img');
      imageElement.src = img.src;
      imageElement.dataset.index = index;
      imageElement.classList.remove('selected');
      imageElement.onclick = () => {
        if (!testCompleted) {
          imageElement.classList.toggle('selected');
        }
      };
      grid.appendChild(imageElement);
    });

    document.getElementById('result').textContent = '';
  }

  function verifySelection() {
    if (testCompleted) return;

    if (attemptCount >= 3) {
      document.getElementById('result').textContent =
        '‚ö†Ô∏è Yritysten enimm√§ism√§√§r√§ (3) saavutettu. Lataa sivu uudelleen aloittaaksesi uudestaan.';
      return;
    }

    attemptCount++;

    const selected = document.querySelectorAll('.grid img.selected');
    const selectedIndexes = Array.from(selected).map(img => parseInt(img.dataset.index));
    const correctIndexes = images
      .map((img, i) => img.isCar ? i : null)
      .filter(i => i !== null);

    const isCorrect = selectedIndexes.length === correctIndexes.length &&
                      selectedIndexes.every(i => correctIndexes.includes(i));

    let score = 0;
    if (attemptCount === 1) score = 3;
    else if (attemptCount === 2) score = 2;
    else if (attemptCount === 3) score = 1;

    localStorage.setItem('captchaAttempts', attemptCount);
    localStorage.setItem('captchaScore', score);

    if (isCorrect) {
      testCompleted = true;
      document.getElementById('result').textContent =
        `üéâ Onnistuit! Yritys nro ${attemptCount}, pisteet: ${score}`;
    } else {
      document.getElementById('result').textContent =
        `‚ùå V√§√§rin. Yritys nro ${attemptCount}, pisteet: ${score}`;
      renderGrid(); // Sekoitetaan kuvat uudelleen
    }
  }

  function showPreviousResults() {
    const previousAttempts = localStorage.getItem('captchaAttempts');
    const previousScore = localStorage.getItem('captchaScore');

    if (previousAttempts && previousScore) {
      const resultText = `üîÅ Edellinen yritys: ${previousAttempts}, pisteet: ${previousScore}`;
      const resultElement = document.createElement('p');
      resultElement.textContent = resultText;
      resultElement.style.fontStyle = 'italic';
      resultElement.style.textAlign = 'center';
      document.body.insertBefore(resultElement, document.getElementById('captchaGrid'));
    }
  }

  showPreviousResults();
  renderGrid();
</script>