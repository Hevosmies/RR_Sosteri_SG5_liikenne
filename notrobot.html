<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Liikennemerkit hallussako?</title>
  <meta name="description" content="Testaa liikennemerkkitietosi nelj√§n pelin avulla ‚Äì hauskaa ja hy√∂dyllist√§ oppimista aikuisille kuljettajille." />
  <link rel="stylesheet" href="./style/notrobot.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
</head>

<body>
  <header>
    <div class="header-bar"></div>
    <nav aria-label="P√§√§valikko">
      <ul>
        <li><a href="index.html">Etusivu</a></li>
        <li><a href="hirsipuu.html">Hirsipuu</a></li>
        <li><a href="notrobot.html">Kuvavalinta</a></li>
        <li><a href="liikennemerkit.html">Liikennemerkit</a></li>
        <li><a href="tietovisa.html">Tietovisa</a></li>
        <li><a href="koostesivu.html">Koostesivu</a></li>
        <li><a href="infosivu.html">Infosivu</a></li>
      </ul>
    </nav>
    <h1>Liikennemerkit hallussako?</h1>
  </header>

  <!-- Kuvien ruudukko -->
  <div class="grid" id="captchaGrid"></div>

  <!-- Napit -->
  <button onclick="verifySelection()">Tarkista</button>
  <button id="retryBtn" onclick="resetTest()" style="display:none;">Yrit√§ uudelleen</button>

  <!-- Tulosviestit -->
  <p id="result"></p>
  <p id="previousResult" style="font-style:italic; text-align:center;"></p>

  <script>
    const images = [
      { src: 'images/notrobot/car1.jpg', isCar: true },
      { src: 'images/notrobot/isitornot.jpg', isCar: false },
      { src: 'images/notrobot/car2.jpg', isCar: true },
      { src: 'images/notrobot/isitornot1.jpg', isCar: false },
      { src: 'images/notrobot/car3.jpg', isCar: true },
      { src: 'images/notrobot/maybecar1.jpg', isCar: true },
      { src: 'images/notrobot/maybecar2.jpg', isCar: false },
      { src: 'images/notrobot/maybecar3.jpg', isCar: false },
      { src: 'images/notrobot/maybecar4.jpg', isCar: false }
    ];

    const grid = document.getElementById('captchaGrid');
    let attemptCount = 0;
    let testCompleted = false;

    // Sekoittaa kuvat satunnaiseen j√§rjestykseen
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // Piirt√§√§ ruudukon
    function renderGrid() {
      grid.innerHTML = '';
      shuffle(images);

      images.forEach((img, index) => {
        const imageElement = document.createElement('img');
        imageElement.src = img.src;
        imageElement.dataset.index = index;
        imageElement.classList.remove('selected');
        imageElement.onclick = () => {
          if (!testCompleted) {
            imageElement.classList.toggle('selected');
          }
        };
        grid.appendChild(imageElement);
      });

      document.getElementById('result').textContent = '';
    }

    // Tarkistaa valinnan
    function verifySelection() {
      if (testCompleted) return;

      if (attemptCount >= 3) {
        document.getElementById('result').textContent =
          '‚ö†Ô∏è Yritysten enimm√§ism√§√§r√§ (3) saavutettu.';
        document.getElementById('retryBtn').style.display = 'inline-block';
        return;
      }

      attemptCount++;

      const selected = document.querySelectorAll('.grid img.selected');
      const selectedIndexes = Array.from(selected).map(img => parseInt(img.dataset.index));
      const correctIndexes = images
        .map((img, i) => img.isCar ? i : null)
        .filter(i => i !== null);

      const isCorrect = selectedIndexes.length === correctIndexes.length &&
                        selectedIndexes.every(i => correctIndexes.includes(i));

      let score = 0;
      if (attemptCount === 1) score = 3;
      else if (attemptCount === 2) score = 2;
      else if (attemptCount === 3) score = 1;

      // Tallennetaan Local Storageen
      localStorage.setItem('captchaAttempts', attemptCount);
      localStorage.setItem('captchaScore', score);

      if (isCorrect) {
        testCompleted = true;
        document.getElementById('result').textContent =
          `üéâ Onnistuit! Yritys nro ${attemptCount}, pisteet: ${score}`;
        document.getElementById('retryBtn').style.display = 'inline-block';
      } else {
        document.getElementById('result').textContent =
          `‚ùå V√§√§rin. Yritys nro ${attemptCount}, pisteet: ${score}`;
        renderGrid(); // Sekoitetaan kuvat uudelleen
      }
    }

    // Nollaa testin
    function resetTest() {
      attemptCount = 0;
      testCompleted = false;
      document.getElementById('result').textContent = '';
      document.getElementById('retryBtn').style.display = 'none';
      renderGrid();
    }

    // N√§ytt√§√§ edellisen tuloksen
    function showPreviousResults() {
      const previousAttempts = localStorage.getItem('captchaAttempts');
      const previousScore = localStorage.getItem('captchaScore');

      if (previousAttempts && previousScore) {
        document.getElementById('previousResult').textContent =
          `üîÅ Edellinen testi: ${previousAttempts} yrityst√§, pisteet: ${previousScore}`;
      }
    }

    showPreviousResults();
    renderGrid();
  </script>
  <footer>
    <p>&copy; 2025 Ryhm√§ 5 ‚Äì TIK25KM | Kuvat: CC0-l√§hteet | Ei ker√§√§ henkil√∂tietoja</p>
  </footer>
</body>
</html>